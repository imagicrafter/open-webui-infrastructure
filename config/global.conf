#!/usr/bin/env bash
# =============================================================================
# Open WebUI Infrastructure - Global Configuration
# =============================================================================
# This file contains centralized configuration for all infrastructure scripts.
# Source this file at the beginning of your scripts:
#   source "$(dirname "$0")/config/global.conf"
# or
#   source "${REPO_ROOT}/config/global.conf"
#
# Environment variables take precedence over defaults defined here.
# =============================================================================

# -----------------------------------------------------------------------------
# Open WebUI Image Configuration
# -----------------------------------------------------------------------------
# These variables control which Open WebUI Docker image to use for deployments.
# You can switch between upstream images, specific versions, or custom forks.

# Base image repository (default: official upstream)
# Examples:
#   - ghcr.io/open-webui/open-webui (official upstream)
#   - ghcr.io/yourname/open-webui (custom fork)
OPENWEBUI_IMAGE="${OPENWEBUI_IMAGE:-ghcr.io/open-webui/open-webui}"

# Image tag/version
# Options:
#   - latest    : Latest stable release (recommended for production)
#   - main      : Development branch (bleeding edge, may have bugs)
#   - dev       : Development builds
#   - v0.5.1    : Specific version (pin for stability)
#   - [custom]  : Any custom tag from your repository
#
# NOTE: Defaults to 'latest' if not set.
#       Override via environment variable or during quick-setup.sh
OPENWEBUI_IMAGE_TAG="${OPENWEBUI_IMAGE_TAG:-latest}"

# Full image reference (computed from above)
# Override this directly to use a completely different image:
#   OPENWEBUI_FULL_IMAGE="myregistry.com/custom-image:tag"
OPENWEBUI_FULL_IMAGE="${OPENWEBUI_FULL_IMAGE:-${OPENWEBUI_IMAGE}:${OPENWEBUI_IMAGE_TAG}}"

# -----------------------------------------------------------------------------
# Directory Structure Configuration
# -----------------------------------------------------------------------------
# Base directory for all Open WebUI deployments on the host
# Each client gets a subdirectory: ${BASE_DIR}/client-name/
BASE_DIR="${BASE_DIR:-/opt/openwebui}"

# Directory containing default Open WebUI static assets
# These are extracted once from the Docker image and used as a template
DEFAULTS_DIR="${DEFAULTS_DIR:-${BASE_DIR}/defaults}"

# Default static assets path (extracted from upstream image)
DEFAULTS_STATIC_DIR="${DEFAULTS_STATIC_DIR:-${DEFAULTS_DIR}/static}"

# Client directory structure template
# Each client gets:
#   ${BASE_DIR}/${CLIENT_NAME}/data/    - SQLite DB, uploads, cache
#   ${BASE_DIR}/${CLIENT_NAME}/static/  - Custom branding assets

# -----------------------------------------------------------------------------
# Container Configuration Defaults
# -----------------------------------------------------------------------------
# Memory limits (Docker container resources)
# These provide basic resource constraints to prevent runaway containers
DEFAULT_MEMORY_LIMIT="${DEFAULT_MEMORY_LIMIT:-700m}"
DEFAULT_MEMORY_RESERVATION="${DEFAULT_MEMORY_RESERVATION:-600m}"
DEFAULT_MEMORY_SWAP="${DEFAULT_MEMORY_SWAP:-1400m}"

# Health check configuration
DEFAULT_HEALTH_CMD="${DEFAULT_HEALTH_CMD:-curl --silent --fail http://localhost:8080/health || exit 1}"
DEFAULT_HEALTH_INTERVAL="${DEFAULT_HEALTH_INTERVAL:-10s}"
DEFAULT_HEALTH_TIMEOUT="${DEFAULT_HEALTH_TIMEOUT:-5s}"
DEFAULT_HEALTH_RETRIES="${DEFAULT_HEALTH_RETRIES:-3}"

# Container restart policy
DEFAULT_RESTART_POLICY="${DEFAULT_RESTART_POLICY:-unless-stopped}"

# -----------------------------------------------------------------------------
# Volume Mount Paths (Inside Container)
# -----------------------------------------------------------------------------
# These are the paths INSIDE the Open WebUI container where volumes are mounted.
# Do NOT change these unless the upstream Open WebUI image structure changes.

# Data volume mount (SQLite DB, uploads, cache)
CONTAINER_DATA_PATH="${CONTAINER_DATA_PATH:-/app/backend/data}"

# Static assets mount (branding, logos, favicons)
CONTAINER_STATIC_PATH="${CONTAINER_STATIC_PATH:-/app/backend/open_webui/static}"

# -----------------------------------------------------------------------------
# Network Configuration
# -----------------------------------------------------------------------------
# Docker network name for Open WebUI containers (optional)
# If set, containers will be attached to this network
# If empty, containers use default bridge network
NETWORK_NAME="${NETWORK_NAME:-}"

# Default port range for client deployments
# First client gets PORT_RANGE_START, second gets PORT_RANGE_START+1, etc.
PORT_RANGE_START="${PORT_RANGE_START:-8081}"

# -----------------------------------------------------------------------------
# OAuth Configuration Placeholders
# -----------------------------------------------------------------------------
# These are placeholders for OAuth configuration.
# Actual values should be set via:
#   1. Environment variables (recommended)
#   2. .env file in deployment directory
#   3. During quick-setup.sh interactive prompts

# Google OAuth
GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID:-}"
GOOGLE_CLIENT_SECRET="${GOOGLE_CLIENT_SECRET:-}"
GOOGLE_REDIRECT_URI="${GOOGLE_REDIRECT_URI:-}"

# OAuth allowed domains (comma-separated)
# Example: "example.com,company.com"
OAUTH_ALLOWED_DOMAINS="${OAUTH_ALLOWED_DOMAINS:-}"

# OpenID provider URL
OPENID_PROVIDER_URL="${OPENID_PROVIDER_URL:-https://accounts.google.com/.well-known/openid-configuration}"

# Enable OAuth signup
ENABLE_OAUTH_SIGNUP="${ENABLE_OAUTH_SIGNUP:-true}"

# Default user role for OAuth signups
DEFAULT_USER_ROLE="${DEFAULT_USER_ROLE:-user}"

# -----------------------------------------------------------------------------
# SSL/TLS Configuration
# -----------------------------------------------------------------------------
# Certbot email for Let's Encrypt
CERTBOT_EMAIL="${CERTBOT_EMAIL:-}"

# Let's Encrypt environment (staging or production)
LETSENCRYPT_ENV="${LETSENCRYPT_ENV:-production}"

# -----------------------------------------------------------------------------
# Branding Configuration
# -----------------------------------------------------------------------------
# Default application name (can be overridden per client)
DEFAULT_WEBUI_NAME="${DEFAULT_WEBUI_NAME:-Open WebUI}"

# Branding mode (Phase 1 or Phase 0)
# Phase 1: Volume mounts (persistent branding)
# Phase 0: Docker cp (branding lost on recreation)
BRANDING_MODE="${BRANDING_MODE:-phase1}"

# -----------------------------------------------------------------------------
# Database Configuration
# -----------------------------------------------------------------------------
# Default database type (sqlite or postgresql)
DEFAULT_DATABASE_TYPE="${DEFAULT_DATABASE_TYPE:-sqlite}"

# PostgreSQL/Supabase connection (if using external database)
DATABASE_URL="${DATABASE_URL:-}"

# -----------------------------------------------------------------------------
# Logging Configuration
# -----------------------------------------------------------------------------
# Log level for infrastructure scripts
LOG_LEVEL="${LOG_LEVEL:-INFO}"

# Log file location (if file logging is enabled)
LOG_FILE="${LOG_FILE:-/var/log/openwebui-infrastructure.log}"

# -----------------------------------------------------------------------------
# Feature Flags
# -----------------------------------------------------------------------------
# Enable experimental features
ENABLE_SYNC="${ENABLE_SYNC:-false}"
ENABLE_HA="${ENABLE_HA:-false}"
ENABLE_MONITORING="${ENABLE_MONITORING:-false}"

# -----------------------------------------------------------------------------
# Validation Functions
# -----------------------------------------------------------------------------
# Function to validate that required variables are set
validate_config() {
    local errors=0

    # Check image variables are set (should always have defaults now)
    if [ -z "$OPENWEBUI_IMAGE_TAG" ]; then
        echo "WARNING: OPENWEBUI_IMAGE_TAG is not set, using default 'latest'"
        OPENWEBUI_IMAGE_TAG="latest"
    fi

    # Validate base directory exists or can be created
    if [ ! -d "$BASE_DIR" ] && [ ! -w "$(dirname "$BASE_DIR")" ]; then
        echo "ERROR: Cannot create BASE_DIR at $BASE_DIR"
        echo "       Ensure you have write permissions"
        ((errors++))
    fi

    return $errors
}

# Function to display current configuration
show_config() {
    echo "==================================================================="
    echo "Open WebUI Infrastructure Configuration"
    echo "==================================================================="
    echo ""
    echo "Image Configuration:"
    echo "  OPENWEBUI_IMAGE:          ${OPENWEBUI_IMAGE}"
    echo "  OPENWEBUI_IMAGE_TAG:      ${OPENWEBUI_IMAGE_TAG:-[NOT SET]}"
    echo "  OPENWEBUI_FULL_IMAGE:     ${OPENWEBUI_FULL_IMAGE:-[NOT SET]}"
    echo ""
    echo "Directory Structure:"
    echo "  BASE_DIR:                 ${BASE_DIR}"
    echo "  DEFAULTS_DIR:             ${DEFAULTS_DIR}"
    echo "  DEFAULTS_STATIC_DIR:      ${DEFAULTS_STATIC_DIR}"
    echo ""
    echo "Container Defaults:"
    echo "  MEMORY_LIMIT:             ${DEFAULT_MEMORY_LIMIT}"
    echo "  MEMORY_RESERVATION:       ${DEFAULT_MEMORY_RESERVATION}"
    echo "  MEMORY_SWAP:              ${DEFAULT_MEMORY_SWAP}"
    echo "  RESTART_POLICY:           ${DEFAULT_RESTART_POLICY}"
    echo ""
    echo "Network:"
    echo "  NETWORK_NAME:             ${NETWORK_NAME:-[default bridge]}"
    echo "  PORT_RANGE_START:         ${PORT_RANGE_START}"
    echo ""
    echo "OAuth (if configured):"
    echo "  GOOGLE_CLIENT_ID:         ${GOOGLE_CLIENT_ID:+[SET]}"
    echo "  OAUTH_ALLOWED_DOMAINS:    ${OAUTH_ALLOWED_DOMAINS:-[NOT SET]}"
    echo ""
    echo "Features:"
    echo "  ENABLE_SYNC:              ${ENABLE_SYNC}"
    echo "  ENABLE_HA:                ${ENABLE_HA}"
    echo "  BRANDING_MODE:            ${BRANDING_MODE}"
    echo "==================================================================="
}

# -----------------------------------------------------------------------------
# Auto-export all configuration variables
# -----------------------------------------------------------------------------
# Export all variables so they're available to child processes
export OPENWEBUI_IMAGE
export OPENWEBUI_IMAGE_TAG
export OPENWEBUI_FULL_IMAGE
export BASE_DIR
export DEFAULTS_DIR
export DEFAULTS_STATIC_DIR
export DEFAULT_MEMORY_LIMIT
export DEFAULT_MEMORY_RESERVATION
export DEFAULT_MEMORY_SWAP
export DEFAULT_HEALTH_CMD
export DEFAULT_HEALTH_INTERVAL
export DEFAULT_HEALTH_TIMEOUT
export DEFAULT_HEALTH_RETRIES
export DEFAULT_RESTART_POLICY
export CONTAINER_DATA_PATH
export CONTAINER_STATIC_PATH
export NETWORK_NAME
export PORT_RANGE_START
export GOOGLE_CLIENT_ID
export GOOGLE_CLIENT_SECRET
export GOOGLE_REDIRECT_URI
export OAUTH_ALLOWED_DOMAINS
export OPENID_PROVIDER_URL
export ENABLE_OAUTH_SIGNUP
export DEFAULT_USER_ROLE
export CERTBOT_EMAIL
export LETSENCRYPT_ENV
export DEFAULT_WEBUI_NAME
export BRANDING_MODE
export DEFAULT_DATABASE_TYPE
export DATABASE_URL
export LOG_LEVEL
export LOG_FILE
export ENABLE_SYNC
export ENABLE_HA
export ENABLE_MONITORING

# -----------------------------------------------------------------------------
# Initialization Message
# -----------------------------------------------------------------------------
# Uncomment to see when this config is loaded (useful for debugging)
# echo "âœ“ Loaded: config/global.conf"
